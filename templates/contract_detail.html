{% extends "base.html" %}
{% block title %}Hợp đồng #{{ contract.id }}{% endblock %}
{% block content %}
<h2>Hợp đồng thuê phòng</h2>
<p><strong>Khách thuê:</strong> {{ tenant.name }}</p>
<p><strong>Từ ngày:</strong> {{ contract.start_date }} <strong>đến ngày:</strong> {{ contract.end_date }} ({{ contract.duration_months }} tháng)</p>
{% if contract.is_extended %}<span class="badge bg-warning">Đã gia hạn</span>{% endif %}

<div class="row mb-4">
    <div class="col-md-6">
        <div class="card shadow">
            <div class="card-header bg-warning text-dark">
                <h5>Gia hạn hợp đồng</h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('extend_contract', contract_id=contract.id) }}">
                    <div class="input-group">
                        <input type="number" name="additional_months" min="1" class="form-control" placeholder="Số tháng gia hạn" required>
                        <button type="submit" class="btn btn-warning">Gia hạn</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <a href="{{ url_for('create_bill', contract_id=contract.id) }}" class="btn btn-primary btn-lg w-100 h-100 d-flex align-items-center justify-content-center">
            <i class="bi bi-receipt fs-4 me-2"></i> Tạo hóa đơn mới
        </a>
    </div>
</div>

<h4>Danh sách hóa đơn</h4>
<div class="table-responsive">
    <table class="table table-striped table-hover">
        <thead class="table-dark">
            <tr>
                <th>Tháng</th>
                <th>Điện cũ (kWh)</th>
                <th>Điện mới (kWh)</th>
                <th>Điện dùng (kWh)</th>
                <th>Tiền điện (đ)</th>
                <th>Nước cũ (m³)</th>
                <th>Nước mới (m³)</th>
                <th>Nước dùng (m³)</th>
                <th>Tiền nước (đ)</th>
                <th>Tổng tiền (VNĐ)</th>
                <th>Trạng thái</th>
                <th>Thao tác</th>
            </tr>
        </thead>
        <tbody>
            {% for bill in bills %}
            <tr>
                <td>{{ bill.month.strftime('%m/%Y') }}</td>
                <td>{{ "%.1f" % bill.electricity_old }}</td>
                <td>{{ "%.1f" % bill.electricity_new }}</td>
                <td>{{ "%.1f" % bill.electricity_usage }}</td>
                <td>{{ "{:,.0f}".format(bill.electricity_usage * bill.electricity_price) }}</td>
                <td>{{ "%.4f" % bill.water_old }}</td>
                <td>{{ "%.4f" % bill.water_new }}</td>
                <td>{{ "%.4f" % bill.water_usage }}</td>
                <!-- Tính tiền nước bậc thang an toàn bằng if-else Jinja chuẩn -->
                <td>
                    {% if bill.water_usage > 5 %}
                        {{ "{:,.0f}".format(5 * 16000 + (bill.water_usage - 5) * 27000) }}
                    {% else %}
                        {{ "{:,.0f}".format(bill.water_usage * 16000) }}
                    {% endif %}
                </td>
                <td class="fw-bold">{{ "{:,.0f}".format(bill.total) }}</td>
                <td>
                    {% if bill.paid %}
                    <span class="badge bg-success">Đã thanh toán</span>
                    {% else %}
                    <span class="badge bg-danger">Chưa thanh toán</span>
                    {% endif %}
                </td>
                <td>
                    <a href="{{ url_for('bill_print', bill_id=bill.id) }}" class="btn btn-sm btn-danger text-white me-1" target="_blank">
                        <i class="bi bi-printer"></i> In
                    </a>
                    <a href="{{ url_for('edit_bill', bill_id=bill.id) }}" class="btn btn-sm btn-warning text-white me-1">
                        <i class="bi bi-pencil"></i> Sửa
                    </a>
                    <form method="POST" action="{{ url_for('delete_bill', bill_id=bill.id) }}" class="d-inline"
                          onsubmit="return confirm('Bạn có chắc muốn xóa hóa đơn này?')">
                        <button type="submit" class="btn btn-sm btn-danger">
                            <i class="bi bi-trash"></i> Xóa
                        </button>
                    </form>
                    {% if not bill.paid %}
                    <form method="POST" action="{{ url_for('pay_bill', bill_id=bill.id) }}" class="d-inline">
                        <button type="submit" class="btn btn-sm btn-success ms-1">Đã trả</button>
                    </form>
                    {% endif %}
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="12" class="text-center">Chưa có hóa đơn nào</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}
